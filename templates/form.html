{% extends "layout.html" %}
{% block content %}

<div class="card shadow p-4 mt-4">
  <h2 class="text-center mb-4">New Shipment</h2>
  <form action="/submit" method="POST" id="shipmentForm">
    <div class="row">
      
     <div class="col-md-6 mb-3 position-relative">
        <label class="form-label">Customer Name</label>

        <input type="text" name="customer_name" id="customer_name" 
              class="form-control" autocomplete="off" required>

        <!-- Suggestion box -->
        <div id="customer_suggestions"
            class="border bg-white position-absolute w-100"
            style="z-index: 999; display:none; max-height: 180px; overflow-y: auto;">
        </div>
      </div>
      
      <div class="col-md-6 mb-3">
        <label class="form-label">Email</label>
        <input type="email" name="customer_email" id="customer_email" class="form-control" required>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <label class="form-label">Phone</label>
        <input type="text" name="customer_phone" id="customer_phone" class="form-control" required>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Origin</label>
        <input type="text" name="origin" id="origin" class="form-control" required>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Destination</label>
        <input type="text" name="destination" id="destination"  class="form-control" required>
      </div>
    </div>

    <div class="row">
      <div class="col-md-3 mb-3">
        <label class="form-label">Weight (kg)</label>
        <input type="number" step="0.1" name="weight" class="form-control">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Qty</label>
        <input type="text" name="qty" class="form-control">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Shipment Date</label>
        <input type="date" name="shipment_date" class="form-control">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Estimated Delivery</label>
        <input type="date" name="est_delivery_date" class="form-control">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Shipping Cost (SAR)</label>
        <input type="number" step="0.01" name="shipping_cost" class="form-control">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Shipping Cost Desc</label>
        <input type="text" name="shipping_cost_desc" class="form-control">
      </div>
    </div>
    
    <div class="row">
      <div class="col-md-3 mb-3">
        <label class="form-label">Freight Cost (SAR)</label>
        <input type="number" step="0.01" name="customer_frt_cost" class="form-control" value="0">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Transport Cost (SAR)</label>
        <input type="number" step="0.01" name="transport_cost" class="form-control" value="0">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Custom Clearance Cost (SAR)</label>
        <input type="number" step="0.01" name="custom_clearance_cost" class="form-control" value="0">
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Other Cost (SAR)</label>
        <input type="number" step="0.01" name="other_cost" class="form-control" value="0">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Other Cost Desc</label>
        <input type="text" name="other_cost_desc" class="form-control">
      </div>
    </div>

    <div class="row">
      <div class="col-md-3 mb-3">
        <label class="form-label">Other Cost 1 (SAR)</label>
        <input type="number" step="0.01" name="other_cost_1" class="form-control" value="0">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Other Cost 1 Desc</label>
        <input type="text" name="other_cost_1_desc" class="form-control">
      </div>

      <div class="col-md-3 mb-3">
        <label class="form-label">Other Cost 2 (SAR)</label>
        <input type="number" step="0.01" name="other_cost_2" class="form-control" value="0">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Other Cost 2 Desc</label>
        <input type="text" name="other_cost_2_desc" class="form-control">
      </div>

      <div class="col-md-3 mb-3">
        <label class="form-label">Other Cost 3 (SAR)</label>
        <input type="number" step="0.01" name="other_cost_3" class="form-control" value="0">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Other Cost 3 Desc</label>
        <input type="text" name="other_cost_3_desc" class="form-control">
      </div>

      <div class="col-md-3 mb-3">
        <label class="form-label">Other Cost 4 (SAR)</label>
        <input type="number" step="0.01" name="other_cost_4" class="form-control" value="0">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Other Cost 4 Desc</label>
        <input type="text" name="other_cost_4_desc" class="form-control">
      </div>
    </div>

    <div class="row">
      <div class="col-md-3 mb-3">
        <label class="form-label">Shipment VAT</label>
        <select name="shipment_vat" id="shipment_vat" class="form-select">
          <option value="0">0%</option>
          <option value="15">15%</option>
        </select>
      </div>
      <div class="col-md-3 mb-3">
        <label class="form-label">Other Cost VAT</label>
         <select name="other_cost_vat" id="other_cost_vat" class="form-select">
           <option value="0">0%</option>
           <option value="15">15%</option>
         </select>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <label class="form-label">Container Number</label>
        <input type="text" name="container_number" id="container_number" class="form-control" required>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">BL Number</label>
        <input type="text" name="bl_number" id="bl_number" class="form-control" required>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Customer Address</label>
        <input type="text" name="customer_address" id="customer_address" class="form-control">
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <label class="form-label">VAT Number</label>
        <input type="text" name="vat_number" id="vat_number" class="form-control" required>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Consignee Name</label>
        <input type="text" name="consignee_name" class="form-control">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Consignee Address</label>
        <input type="text" name="consignee_address" class="form-control">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Customs Agent</label>
        <input type="text" name="customs_agent" class="form-control">
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-3">
        <label class="form-label">Carrier</label>
        <input type="text" name="carrier" class="form-control">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Driver</label>
        <input type="text" name="driver" class="form-control">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option selected>Pending</option>
          <option>In Transit</option>
          <option>Delivered</option>
          <option>Cancelled</option>
        </select>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">Comments</label>
        <input type="text" name="comments" class="form-control">
      </div>
    </div>

    <div class="d-grid gap-2 mt-3">
      <button class="btn btn-primary" type="submit">Submit Shipment</button>
      <a href="/shipments" class="btn btn-success">View Shipment List</a>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const input = document.getElementById("customer_name");
    const box = document.getElementById("customer_suggestions");

    // üîç Live search for customer names
    input.addEventListener("keyup", function () {
        const text = input.value.trim();
        if (text.length < 1) {
            box.style.display = "none";
            box.innerHTML = "";
            return;
        }

        fetch(`/search_customers?q=${encodeURIComponent(text)}`)
            .then(res => res.json())
            .then(data => {
                box.innerHTML = "";
                if (!data.customers.length) {
                    box.style.display = "none";
                    return;
                }

                box.style.display = "block";

                data.customers.forEach(name => {
                    const item = document.createElement("div");
                    item.classList.add("p-2");
                    item.style.cursor = "pointer";
                    item.innerText = name;

                    item.onclick = () => {
                        input.value = name;
                        box.innerHTML = "";
                        box.style.display = "none";

                        // Fetch full details
                        fetch(`/get_customer/${encodeURIComponent(name)}`)
                            .then(r => r.json())
                            .then(info => {
                                document.getElementById("customer_email").value = info.customer_email || "";
                                document.getElementById("customer_phone").value = info.customer_phone || "";
                                document.getElementById("origin").value = info.origin || "";
                                document.getElementById("destination").value = info.destination || "";
                                document.getElementById("container_number").value = info.container_number || "";
                                document.getElementById("bl_number").value = info.bl_number || "";
                                document.getElementById("customer_address").value = info.customer_address || "";
                                document.getElementById("vat_number").value = info.vat_number || "";
                            });
                    };

                    box.appendChild(item);
                });
            });
    });

    // hide suggestions when clicking outside
    document.addEventListener("click", function(e) {
        if (!input.contains(e.target) && !box.contains(e.target)) {
            box.style.display = "none";
        }
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const customerInput = document.getElementById("customer_name");

    customerInput.addEventListener("blur", function() {
        const name = customerInput.value.trim();
        if (name) {
            fetch(`/get_customer/${encodeURIComponent(name)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.customer_email) {
                        document.getElementById("customer_email").value = data.customer_email || "";
                        document.getElementById("customer_phone").value = data.customer_phone || "";
                        document.getElementById("origin").value = data.origin || "";
                        document.getElementById("destination").value = data.destination || "";
                        document.getElementById("container_number").value = data.container_number || "";
                        document.getElementById("bl_number").value = data.bl_number || "";
                        document.getElementById("customer_address").value = data.customer_address || "";
                        document.getElementById("vat_number").value = data.vat_number || "";
                    }
                })
                .catch(err => console.error("Error fetching customer data:", err));
        }
    });
});
</script>

{% endblock %}